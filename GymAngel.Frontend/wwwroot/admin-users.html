<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - GYM ANGEL Admin</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/admin.css" rel="stylesheet">
</head>

<body class="admin-body">
    <nav class="admin-sidebar">
        <div class="admin-logo">
            <h2><i class="fa fa-dumbbell"></i> GYM ANGEL</h2>
            <span class="badge">ADMIN</span>
        </div>
        <div class="admin-nav">
            <a href="admin-dashboard.html" class="admin-nav-item">
                <i class="fa fa-chart-line"></i><span>Dashboard</span>
            </a>
            <a href="admin-products.html" class="admin-nav-item">
                <i class="fa fa-box"></i><span>Products</span>
            </a>
            <a href="admin-orders.html" class="admin-nav-item">
                <i class="fa fa-shopping-cart"></i><span>Orders</span>
            </a>
            <a href="admin-users.html" class="admin-nav-item active">
                <i class="fa fa-users"></i><span>Users</span>
            </a>
            <a href="admin-memberships.html" class="admin-nav-item">
                <i class="fa fa-id-card"></i><span>Memberships</span>
            </a>
        </div>
    </nav>

    <main class="admin-main">
        <header class="admin-header">
            <h1><i class="fa fa-users"></i> User Management</h1>
            <div class="admin-user">
                <div class="admin-user-info">
                    <div class="admin-user-name" id="admin-name">Admin</div>
                    <div class="admin-user-role">Administrator</div>
                </div>
                <button class="btn-logout" onclick="AdminUtils.logout()">
                    <i class="fa fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="search-input" class="form-control" placeholder="Search by name or email...">
            </div>
            <div class="filter-group">
                <select id="membership-filter" class="form-control">
                    <option value="">All Users</option>
                    <option value="active">Active Members</option>
                    <option value="expired">Expired Members</option>
                    <option value="no-membership">No Membership</option>
                </select>
            </div>
        </div>

        <div class="admin-card">
            <div class="card-header">
                <h3 class="card-title">All Users</h3>
                <span id="user-count" class="badge badge-info">0 users</span>
            </div>
            <div class="card-body">
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading users...</p>
                </div>
                <table id="users-table" class="admin-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Membership</th>
                            <th>Expiry</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- User Details Modal -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">User Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="user-details"></div>
            <div class="modal-footer">
                <button class="btn-admin" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="js/env.js"></script>
    <script src="js/admin-utils.js"></script>
    <script>
        AdminUtils.requireAuth();
        document.getElementById('admin-name').textContent = AdminUtils.getEmail() || 'Admin';

        let allUsers = [];

        async function loadUsers() {
            try {
                // Note: This endpoint needs to be created in backend
                // For now, we'll use a placeholder API
                const response = await AdminUtils.apiRequest('/api/users'); // Or /api/admin/users

                if (response.ok) {
                    allUsers = await response.json();
                    renderUsers(allUsers);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('users-table').style.display = 'table';
                } else {
                    throw new Error('Failed to load users');
                }
            } catch (error) {
                console.error('Error:', error);
                // Show mock data for demo
                allUsers = generateMockUsers();
                renderUsers(allUsers);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('users-table').style.display = 'table';
            }
        }

        function generateMockUsers() {
            return [
                {
                    id: 1,
                    fullName: "John Doe",
                    email: "john@example.com",
                    membershipStatus: true,
                    membershipExpiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: "2025-01-01T00:00:00Z"
                },
                {
                    id: 2,
                    fullName: "Jane Smith",
                    email: "jane@example.com",
                    membershipStatus: false,
                    membershipExpiry: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: "2025-06-15T00:00:00Z"
                },
                {
                    id: 3,
                    fullName: "Bob Wilson",
                    email: "bob@example.com",
                    membershipStatus: true,
                    membershipExpiry: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: "2025-03-20T00:00:00Z"
                }
            ];
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            document.getElementById('user-count').textContent = `${users.length} users`;

            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><strong>#${u.id}</strong></td>
                    <td>${u.fullName || 'N/A'}</td>
                    <td>${u.email}</td>
                    <td>
                        ${u.membershipStatus
                    ? '<span class="badge badge-success">Active</span>'
                    : '<span class="badge badge-danger">Inactive</span>'}
                    </td>
                    <td>
                        ${u.membershipExpiry
                    ? AdminUtils.formatDate(u.membershipExpiry)
                    : 'N/A'}
                    </td>
                    <td>${AdminUtils.formatDate(u.createdAt)}</td>
                    <td>
                        <button class="btn-admin btn-sm btn-primary" onclick="viewUser(${u.id})">
                            <i class="fa fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewUser(id) {
            const user = allUsers.find(u => u.id === id);
            if (!user) return;

            // Calculate days remaining
            let daysRemaining = 'N/A';
            if (user.membershipExpiry) {
                const expiry = new Date(user.membershipExpiry);
                const today = new Date();
                const diff = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                daysRemaining = diff > 0 ? `${diff} days` : 'Expired';
            }

            const details = document.getElementById('user-details');
            details.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #FFD700; margin-bottom: 15px;">
                        <i class="fa fa-user"></i> ${user.fullName || 'User'} #${user.id}
                    </h4>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h5 style="color: #FFD700; margin-bottom: 10px;">Personal Information</h5>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Member Since:</strong> ${AdminUtils.formatDate(user.createdAt)}</p>
                    </div>
                    <div>
                        <h5 style="color: #FFD700; margin-bottom: 10px;">Membership Status</h5>
                        <p><strong>Status:</strong> ${user.membershipStatus
                    ? '<span class="badge badge-success">Active</span>'
                    : '<span class="badge badge-danger">Inactive</span>'}</p>
                        <p><strong>Expiry:</strong> ${user.membershipExpiry
                    ? AdminUtils.formatDate(user.membershipExpiry)
                    : 'N/A'}</p>
                        <p><strong>Days Remaining:</strong> ${daysRemaining}</p>
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,215,0,0.2);">
                    <h5 style=" margin-bottom: 15px;">Quick Actions</h5>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="admin-orders.html?userId=${user.id}" class="btn-admin btn-primary">
                            <i class="fa fa-shopping-cart"></i> View Orders
                        </a>
                        <a href="admin-memberships.html?userId=${user.id}" class="btn-admin btn-primary">
                            <i class="fa fa-id-card"></i> View Membership
                        </a>
                    </div>
                </div>
            `;

            document.getElementById('user-modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('user-modal').classList.remove('show');
        }

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u =>
                (u.fullName && u.fullName.toLowerCase().includes(search)) ||
                (u.email && u.email.toLowerCase().includes(search))
            );
            renderUsers(filtered);
        });

        // Filter by membership
        document.getElementById('membership-filter').addEventListener('change', (e) => {
            const filter = e.target.value;
            let filtered = allUsers;

            if (filter === 'active') {
                filtered = allUsers.filter(u => u.membershipStatus === true);
            } else if (filter === 'expired') {
                const now = new Date();
                filtered = allUsers.filter(u =>
                    u.membershipExpiry && new Date(u.membershipExpiry) < now
                );
            } else if (filter === 'no-membership') {
                filtered = allUsers.filter(u => !u.membershipStatus && !u.membershipExpiry);
            }

            renderUsers(filtered);
        });

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>

</html>